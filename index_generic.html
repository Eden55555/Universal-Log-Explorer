<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Analyzer - Generic & Configurable</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --header-bg: #2c3e50;
            --text-main: #333;
            --text-secondary: #ffffff;
            --border-color: #dee2e6;
            --error-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #27ae60;
            --row-height: 40px;
            --json-key: #881391;
            --json-string: #c41a16;
            --json-number: #1c11ee;
            --json-bool: #0d904f;
            --selected-row-bg: #e3f2fd;
            --selected-row-border: #2196f3;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --header-bg: #0d1117;
            --text-main: #e6edf3;
            --border-color: #30363d;
            --selected-row-bg: #1f2937;
            --selected-row-border: #3b82f6;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: var(--text-main);
            background-color: var(--bg-color);
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Configuration Modal */
        .config-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .config-modal.active {
            display: flex;
        }

        .config-content {
            background: var(--bg-color);
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .config-header h2 {
            margin: 0;
            color: var(--text-main);
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-section h3 {
            margin: 0 0 15px 0;
            color: var(--text-main);
            font-size: 16px;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .template-btn {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-main);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .template-btn:hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .template-btn.active {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .template-btn strong {
            display: block;
            margin-bottom: 5px;
        }

        .template-btn small {
            color: #666;
            font-size: 11px;
        }

        .column-config {
            display: grid;
            grid-template-columns: 1fr 2fr 2fr 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.02);
            border-radius: 6px;
        }

        [data-theme="dark"] .column-config {
            background: rgba(255,255,255,0.02);
        }

        .column-config input[type="text"],
        .column-config input[type="checkbox"],
        .column-config select {
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-main);
            font-size: 12px;
        }

        .column-config input[type="text"] {
            font-family: 'Courier New', monospace;
        }

        .btn-add-column {
            padding: 8px 15px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }

        .btn-add-column:hover {
            background: #229954;
        }

        .btn-remove-column {
            padding: 4px 8px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .btn-remove-column:hover {
            background: #c0392b;
        }

        .parser-config {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.02);
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }

        [data-theme="dark"] .parser-config {
            background: rgba(255,255,255,0.02);
        }

        .parser-config input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-main);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 5px;
        }

        .parser-config label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .preview-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.02);
            border-radius: 6px;
        }

        [data-theme="dark"] .preview-section {
            background: rgba(255,255,255,0.02);
        }

        .preview-line {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 8px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .preview-result {
            display: grid;
            gap: 5px;
            margin-top: 10px;
        }

        .preview-field {
            padding: 5px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 3px;
            font-size: 11px;
        }

        .preview-field strong {
            color: #3498db;
        }

        .btn-primary {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            padding: 10px 20px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .config-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }

        /* Header & Controls */
        .app-header {
            padding: 10px 20px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 10;
            flex-wrap: wrap;
            color: var(--text-secondary)!important;
        }

        .drop-zone {
            flex-grow: 1;
            min-width: 200px;
            border: 2px dashed var(--border-color);
            padding: 8px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .drop-zone:hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .drop-zone.dragover {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .controls-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .encoding-select, .search-box, .filter-select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            background: var(--bg-color);
            color: var(--text-main);
        }

        .search-box { width: 200px; }
        .filter-select { width: 120px; }

        .btn-header {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-color);
            color: var(--text-main);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn-header:hover {
            background: rgba(52, 152, 219, 0.1);
            border-color: #3498db;
        }

        /* Loading Indicator */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Virtual List Styling */
        .table-header {
            display: grid;
            background: var(--header-bg);
            color: white;
            font-weight: 600;
            font-size: 13px;
            padding: 0 15px;
            height: 45px;
            line-height: 45px;
            z-index: 5;
        }

        .table-header > div {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }

        .table-header > div:hover {
            background: rgba(255,255,255,0.1);
        }

        .table-header > div::after {
            content: ' ‚Üï';
            opacity: 0.5;
            font-size: 10px;
        }

        /* Column Resizer */
        .table-header > div {
            position: relative;
        }

        .column-resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            z-index: 100;
            background: transparent;
            transition: background 0.2s;
            margin-right: -2px;
        }

        .column-resizer:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .column-resizer.resizing {
            background: rgba(255, 255, 255, 0.6);
        }

        .table-header > div:last-child .column-resizer {
            display: none;
        }

        #viewport {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
            background: var(--bg-color);
            outline: none;
        }

        #spacer {
            position: absolute;
            top: 0; left: 0; width: 100%;
            pointer-events: none;
        }

        #content {
            position: absolute;
            top: 0; left: 0; width: 100%;
        }

        .row {
            display: grid;
            height: var(--row-height);
            line-height: var(--row-height);
            padding: 0 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.1s;
        }

        .row:hover {
            background-color: rgba(0,0,0,0.03);
        }

        [data-theme="dark"] .row:hover {
            background-color: rgba(255,255,255,0.03);
        }

        .row.selected {
            background-color: var(--selected-row-bg);
            border-left: 3px solid var(--selected-row-border);
        }

        .row:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] .row:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .row > div {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 10px;
        }

        mark {
            background-color: #ffeb3b;
            padding: 2px 0;
        }

        [data-theme="dark"] mark {
            background-color: #f57f17;
            color: #000;
        }

        /* Custom word highlighting */
        .custom-highlight {
            padding: 2px 0;
            font-weight: bold;
        }

        /* Highlight word picker */
        .highlight-picker {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 300px;
            display: none;
        }

        .highlight-picker.active {
            display: block;
        }

        .highlight-picker input[type="text"],
        .highlight-picker input[type="color"] {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-main);
        }

        .highlight-picker .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Details Overlay */
        .details-overlay {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 600px;
            background: var(--bg-color);
            border-left: 1px solid var(--border-color);
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
        }

        .details-overlay.open {
            transform: translateX(0);
        }

        .details-header {
            padding: 15px 20px;
            background: var(--header-bg);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .details-actions {
            display: flex;
            gap: 10px;
        }

        .details-actions .btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .details-actions .btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .close-btn {
            background: rgba(231, 76, 60, 0.8) !important;
        }

        .close-btn:hover {
            background: rgba(231, 76, 60, 1) !important;
        }

        .details-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-color);
        }

        .details-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            color: var(--text-main);
            font-size: 13px;
            transition: all 0.2s;
        }

        .details-tab:hover {
            background: rgba(0,0,0,0.05);
        }

        [data-theme="dark"] .details-tab:hover {
            background: rgba(255,255,255,0.05);
        }

        .details-tab.active {
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: 600;
        }

        .details-tab-content {
            display: none;
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .details-tab-content.active {
            display: block;
        }

        .details-search {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-color);
        }

        .details-search input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-main);
        }

        /* JSON Tree */
        .json-tree {
            list-style: none;
            padding-left: 20px;
            margin: 5px 0;
        }

        .json-node {
            margin: 3px 0;
        }

        .json-toggle {
            cursor: pointer;
            display: inline-block;
            width: 12px;
            margin-right: 5px;
            transition: transform 0.2s;
        }

        .json-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .json-key {
            color: var(--json-key);
            font-weight: 600;
        }

        .json-string {
            color: var(--json-string);
        }

        .json-number {
            color: var(--json-number);
        }

        .json-bool {
            color: var(--json-bool);
        }

        .json-null {
            color: #888;
            font-style: italic;
        }

        .collapsed-content {
            display: none;
        }

        /* Status Classes */
        .st-err {
            color: var(--error-color);
        }

        .st-warn {
            color: var(--warning-color);
        }

        .st-ok {
            color: var(--success-color);
        }

        /* Filter Badges */
        .filter-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
        }

        .filter-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #3498db;
            color: white;
            border-radius: 12px;
            font-size: 11px;
        }

        .filter-badge .remove {
            cursor: pointer;
            font-weight: bold;
            margin-left: 4px;
        }

        .filter-badge .remove:hover {
            opacity: 0.8;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            font-size: 13px;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Stats Panel */
        .stats-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 100;
            display: none;
            max-width: 300px;
        }

        .stats-panel.active {
            display: block;
        }

        .stats-panel h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .file-path {
            padding: 5px 20px;
            background: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            font-size: 11px;
            color: var(--text-main);
            font-family: 'Courier New', monospace;
            display: none;
        }

        .file-path.active {
            display: block;
        }

        .bookmark-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .row.bookmarked {
            background-color: rgba(255, 235, 59, 0.1) !important;
        }

        [data-theme="dark"] .row.bookmarked {
            background-color: rgba(255, 235, 59, 0.15) !important;
        }
    </style>
</head>
<body>
    <!-- Configuration Modal -->
    <div class="config-modal" id="config-modal">
        <div class="config-content">
            <div class="config-header">
                <h2>Configure Log Format</h2>
                <button class="close-btn" onclick="closeConfig()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">√ó</button>
            </div>

            <div class="config-section">
                <h3>1. Choose a Template (or create custom)</h3>
                <div class="template-grid" id="template-grid">
                    <!-- Templates will be added by JavaScript -->
                </div>
            </div>

            <div class="config-section">
                <h3>2. Define Columns</h3>
                <div id="columns-config">
                    <!-- Columns will be added by JavaScript -->
                </div>
                <button class="btn-add-column" onclick="addColumn()">+ Add Column</button>
            </div>

            <div class="config-section">
                <h3>3. Define Parsers (Regex Patterns)</h3>
                <div id="parsers-config">
                    <!-- Parsers will be added by JavaScript -->
                </div>
                <button class="btn-add-column" onclick="addParser()">+ Add Parser</button>
            </div>

            <div class="config-section">
                <h3>4. Test with Sample Line</h3>
                <div class="preview-section">
                    <label>Sample log line:</label>
                    <input type="text" id="preview-line" class="preview-line" placeholder="Paste a sample log line here to test parsing..." oninput="testParsing()">
                    <div id="preview-result" class="preview-result"></div>
                </div>
            </div>

            <div class="config-actions">
                <button class="btn-secondary" onclick="closeConfig()">Cancel</button>
                <button class="btn-primary" onclick="saveConfig()">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-header">
        <div id="drop-zone" class="drop-zone" role="button" tabindex="0" aria-label="Drop zone for log files">Click or drag a log file here</div>
        <input type="file" id="file-input" style="display: none;" accept=".log,.txt,.json">
        
        <div class="controls-group">
            <button class="btn-header" id="btn-config" aria-label="Configure log format">‚öôÔ∏è Configure</button>
            <label for="encoding-select" style="font-size: 12px;">Encoding:</label>
            <select id="encoding-select" class="encoding-select" aria-label="File encoding">
                <option value="UTF-8" selected>UTF-8</option>
                <option value="windows-1255">Windows-1255</option>
                <option value="ISO-8859-8">ISO-8859-8</option>
                <option value="ISO-8859-1">ISO-8859-1</option>
            </select>
            <input type="text" id="search" class="search-box" placeholder="Search..." hidden aria-label="Search logs">
            <input type="number" id="jump-to-line" class="search-box" placeholder="Line #" hidden style="width: 80px;" aria-label="Jump to line number" min="1">
            <button class="btn-header" id="btn-jump" hidden aria-label="Jump to line">Jump</button>
            <button class="btn-header" id="btn-refresh" hidden aria-label="Refresh file">üîÑ Refresh</button>
            <button class="btn-header" id="btn-export" hidden aria-label="Export logs">Export</button>
            <button class="btn-header" id="btn-export-bookmarks" hidden aria-label="Export bookmarks only">Export Bookmarks</button>
            <button class="btn-header" id="btn-stats" hidden aria-label="Show statistics">Stats</button>
            <button class="btn-header" id="btn-highlight" hidden aria-label="Highlight word">Highlight</button>
            <button class="btn-header" id="btn-theme" aria-label="Toggle dark mode">üåô</button>
        </div>
        
        <div id="stats" style="font-size: 11px; min-width: 100px;">Ready. Click Configure to set up log format.</div>
    </div>

    <div class="file-path" id="file-path"></div>

    <div class="table-header" id="table-header" role="row" style="display: none;">
        <!-- Headers will be generated dynamically -->
    </div>

    <div id="viewport" tabindex="0" role="grid" aria-label="Log entries">
        <div id="spacer"></div>
        <div id="content"></div>
    </div>

    <div class="stats-panel" id="stats-panel" role="dialog" aria-label="Statistics">
        <h3>Statistics</h3>
        <div id="stats-content"></div>
    </div>

    <div id="details-overlay" class="details-overlay" role="dialog" aria-label="Log details" aria-hidden="true">
        <div id="resizer"></div>
        <div class="details-header">
            <span>Detailed Analysis</span>
            <div class="details-actions">
                <button class="btn" onclick="toggleMaximize()" aria-label="Maximize panel">Maximize</button>
                <button class="btn" onclick="copyAll()" aria-label="Copy all content">Copy All</button>
                <button class="close-btn" onclick="closeDetails()" aria-label="Close details">&times;</button>
            </div>
        </div>
        <div class="details-search" id="details-search" style="display: none;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="text" id="details-search-input" placeholder="Search in details..." aria-label="Search in details" style="flex: 1;">
                <span id="details-search-results" style="font-size: 12px; color: var(--text-main); min-width: 100px; text-align: right;"></span>
                <button class="btn" id="btn-search-prev" aria-label="Previous result" style="padding: 4px 8px; font-size: 12px;color: var(--text-main); display: none;" disabled>‚óÄ Prev</button>
                <button class="btn" id="btn-search-next" aria-label="Next result" style="padding: 4px 8px; font-size: 12px;color: var(--text-main); display: none;" disabled>Next ‚ñ∂</button>
            </div>
        </div>
        <div class="details-tabs">
            <button class="details-tab active" data-tab="raw" onclick="switchDetailsTab('raw')">RAW</button>
            <button class="details-tab" data-tab="json" onclick="switchDetailsTab('json')">JSON</button>
            <button class="details-tab" data-tab="metadata" onclick="switchDetailsTab('metadata')">Metadata</button>
        </div>
        <div id="details-body" class="details-body" style="padding: 0; overflow: hidden; display: flex; flex-direction: column;">
            <div class="details-tab-content active" id="tab-raw" style="flex: 1; overflow: auto; padding: 20px;"></div>
            <div class="details-tab-content" id="tab-json" style="flex: 1; overflow: auto; padding: 20px;"></div>
            <div class="details-tab-content" id="tab-metadata" style="flex: 1; overflow: auto; padding: 20px;"></div>
        </div>
    </div>

    <div class="toast" id="toast" role="alert" aria-live="polite"></div>

    <!-- Highlight Picker Modal -->
    <div id="highlight-picker" class="highlight-picker">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0;">Highlight Word</h3>
            <button class="close-btn" onclick="closeHighlightPicker()" style="font-size: 20px; line-height: 1; border: none; background: none; color: var(--text-main); cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;" aria-label="Close highlight picker">&times;</button>
        </div>
        <label>Word to highlight:</label>
        <input type="text" id="highlight-word" placeholder="Enter word or phrase">
        <label>Color:</label>
        <input type="color" id="highlight-color" value="#ffff00">
        <div class="btn-group">
            <button class="btn" onclick="applyHighlight()" style="flex: 1;color: var(--text-main);">Apply</button>
            <button class="btn" onclick="clearAllHighlights()" style="flex: 1;color: var(--text-main);">Clear All</button>
            <button class="btn" onclick="closeHighlightPicker()" style="flex: 1;color: var(--text-main);">Cancel</button>
        </div>
    </div>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Loading file...</div>
    </div>

<script>
    /**
     * Application State
     */
    const ROW_HEIGHT = 40;
    const VISIBLE_COUNT = 40;
    let allLogs = [];
    let filteredLogs = [];
    let currentFile = null;
    let selectedIndex = -1;
    let sortColumn = null;
    let sortDirection = 'asc';
    let statusClassCache = new Map();
    let bookmarkedLogs = new Set();
    let currentConfig = null;
    let currentDetailsTab = 'raw';
    let columnWidths = null; // Will be initialized based on config
    let isColumnResizing = false;

    /**
     * Default Configuration Templates
     */
    const logTemplates = {
        'apache-common': {
            name: 'Apache Common Log Format',
            description: 'Standard Apache access logs',
            columns: [
                { key: 'ip', label: 'IP', visible: true, sortable: true },
                { key: 'date', label: 'Date/Time', visible: true, sortable: true },
                { key: 'method', label: 'Method', visible: true, sortable: true },
                { key: 'path', label: 'Path', visible: true, sortable: true },
                { key: 'status', label: 'Status', visible: true, sortable: true },
                { key: 'size', label: 'Size', visible: true, sortable: true }
            ],
            parsers: [
                {
                    name: 'Apache Common',
                    regex: '^(\\S+) \\S+ \\S+ \\[(.*?)\\] "(\\S+) (\\S+) \\S+" (\\d{3}) (\\d+|-)',
                    fieldMapping: {
                        ip: '$1',
                        date: '$2',
                        method: '$3',
                        path: '$4',
                        status: '$5',
                        size: '$6'
                    }
                }
            ]
        },
        'apache-combined': {
            name: 'Apache Combined Log Format',
            description: 'Apache logs with referrer and user agent',
            columns: [
                { key: 'ip', label: 'IP', visible: true, sortable: true },
                { key: 'date', label: 'Date/Time', visible: true, sortable: true },
                { key: 'method', label: 'Method', visible: true, sortable: true },
                { key: 'path', label: 'Path', visible: true, sortable: true },
                { key: 'status', label: 'Status', visible: true, sortable: true },
                { key: 'size', label: 'Size', visible: true, sortable: true },
                { key: 'referer', label: 'Referer', visible: true, sortable: true },
                { key: 'userAgent', label: 'User Agent', visible: true, sortable: false }
            ],
            parsers: [
                {
                    name: 'Apache Combined',
                    regex: '^(\\S+) \\S+ \\S+ \\[(.*?)\\] "(\\S+) (\\S+) \\S+" (\\d{3}) (\\d+|-) "(.*?)" "(.*?)"',
                    fieldMapping: {
                        ip: '$1',
                        date: '$2',
                        method: '$3',
                        path: '$4',
                        status: '$5',
                        size: '$6',
                        referer: '$7',
                        userAgent: '$8'
                    }
                }
            ]
        },
        'nginx': {
            name: 'Nginx Access Log',
            description: 'Standard Nginx access logs',
            columns: [
                { key: 'ip', label: 'IP', visible: true, sortable: true },
                { key: 'date', label: 'Date/Time', visible: true, sortable: true },
                { key: 'method', label: 'Method', visible: true, sortable: true },
                { key: 'path', label: 'Path', visible: true, sortable: true },
                { key: 'status', label: 'Status', visible: true, sortable: true },
                { key: 'size', label: 'Size', visible: true, sortable: true }
            ],
            parsers: [
                {
                    name: 'Nginx',
                    regex: '^(\\S+) - - \\[(.*?)\\] "(\\S+) (\\S+) \\S+" (\\d{3}) (\\d+)',
                    fieldMapping: {
                        ip: '$1',
                        date: '$2',
                        method: '$3',
                        path: '$4',
                        status: '$5',
                        size: '$6'
                    }
                }
            ]
        },
        'json': {
            name: 'JSON Logs',
            description: 'Structured JSON log format',
            columns: [
                { key: 'timestamp', label: 'Timestamp', visible: true, sortable: true },
                { key: 'level', label: 'Level', visible: true, sortable: true },
                { key: 'message', label: 'Message', visible: true, sortable: false },
                { key: 'source', label: 'Source', visible: true, sortable: true },
                { key: 'ip', label: 'IP', visible: true, sortable: true }
            ],
            parsers: [
                {
                    name: 'JSON',
                    regex: '^\\s*\\{.*\\}\\s*$',
                    fieldMapping: {
                        timestamp: '$.timestamp || $.time || $.date',
                        level: '$.level || $.severity',
                        message: '$.message || $.msg',
                        source: '$.source || $.service',
                        ip: '$.ip || $.remote_addr'
                    },
                    isJson: true
                }
            ]
        },
        'syslog': {
            name: 'Syslog',
            description: 'Standard syslog format',
            columns: [
                { key: 'date', label: 'Date/Time', visible: true, sortable: true },
                { key: 'host', label: 'Host', visible: true, sortable: true },
                { key: 'facility', label: 'Facility', visible: true, sortable: true },
                { key: 'level', label: 'Level', visible: true, sortable: true },
                { key: 'message', label: 'Message', visible: true, sortable: false }
            ],
            parsers: [
                {
                    name: 'Syslog',
                    regex: '^(\\w{3}\\s+\\d{1,2}\\s+\\d{2}:\\d{2}:\\d{2})\\s+(\\S+)\\s+(\\w+)\\.(\\w+):\\s+(.*)',
                    fieldMapping: {
                        date: '$1',
                        host: '$2',
                        facility: '$3',
                        level: '$4',
                        message: '$5'
                    }
                }
            ]
        },
        'custom': {
            name: 'Custom Format',
            description: 'Define your own format',
            columns: [
                { key: 'date', label: 'Date', visible: true, sortable: true },
                { key: 'level', label: 'Level', visible: true, sortable: true },
                { key: 'message', label: 'Message', visible: true, sortable: false }
            ],
            parsers: [
                {
                    name: 'Custom Parser',
                    regex: '.*',
                    fieldMapping: {
                        date: '',
                        level: '',
                        message: '$0'
                    }
                }
            ]
        }
    };

    /**
     * Initialize Configuration
     */
    function initConfig() {
        // Load saved config or show config modal
        const savedConfig = localStorage.getItem('logAnalyzerConfig');
        if (savedConfig) {
            try {
                currentConfig = JSON.parse(savedConfig);
                applyConfig();
            } catch (e) {
                showConfigModal();
            }
        } else {
            showConfigModal();
        }
    }

    /**
     * Show Configuration Modal
     */
    function showConfigModal() {
        document.getElementById('config-modal').classList.add('active');
        renderTemplates();
        renderColumns();
        renderParsers();
    }

    /**
     * Close Configuration Modal
     */
    function closeConfig() {
        document.getElementById('config-modal').classList.remove('active');
    }

    /**
     * Render Template Buttons
     */
    function renderTemplates() {
        const grid = document.getElementById('template-grid');
        grid.innerHTML = '';
        
        Object.keys(logTemplates).forEach(key => {
            const template = logTemplates[key];
            const btn = document.createElement('button');
            btn.className = 'template-btn';
            btn.innerHTML = `<strong>${template.name}</strong><small>${template.description}</small>`;
            btn.onclick = () => loadTemplate(key);
            grid.appendChild(btn);
        });
    }

    /**
     * Load Template
     */
    function loadTemplate(templateKey) {
        const template = logTemplates[templateKey];
        currentConfig = JSON.parse(JSON.stringify(template)); // Deep copy
        
        // Update UI
        document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('active'));
        event.target.closest('.template-btn').classList.add('active');
        
        renderColumns();
        renderParsers();
        testParsing();
    }

    /**
     * Render Columns Configuration
     */
    function renderColumns() {
        const container = document.getElementById('columns-config');
        container.innerHTML = '';
        
        if (!currentConfig || !currentConfig.columns) {
            currentConfig = { columns: [], parsers: [] };
        }
        
        currentConfig.columns.forEach((col, idx) => {
            const div = document.createElement('div');
            div.className = 'column-config';
            div.innerHTML = `
                <input type="text" placeholder="Field key" value="${col.key || ''}" onchange="updateColumn(${idx}, 'key', this.value)">
                <input type="text" placeholder="Column label" value="${col.label || ''}" onchange="updateColumn(${idx}, 'label', this.value)">
                <label><input type="checkbox" ${col.visible !== false ? 'checked' : ''} onchange="updateColumn(${idx}, 'visible', this.checked)"> Visible</label>
                <label><input type="checkbox" ${col.sortable ? 'checked' : ''} onchange="updateColumn(${idx}, 'sortable', this.checked)"> Sortable</label>
                <button class="btn-remove-column" onclick="removeColumn(${idx})">Remove</button>
            `;
            container.appendChild(div);
        });
    }

    /**
     * Add Column
     */
    function addColumn() {
        if (!currentConfig) currentConfig = { columns: [], parsers: [] };
        if (!currentConfig.columns) currentConfig.columns = [];
        
        currentConfig.columns.push({
            key: `field${currentConfig.columns.length + 1}`,
            label: `Field ${currentConfig.columns.length + 1}`,
            visible: true,
            sortable: true
        });
        renderColumns();
    }

    /**
     * Update Column
     */
    function updateColumn(idx, prop, value) {
        if (currentConfig && currentConfig.columns && currentConfig.columns[idx]) {
            currentConfig.columns[idx][prop] = value;
        }
    }

    /**
     * Remove Column
     */
    function removeColumn(idx) {
        if (currentConfig && currentConfig.columns) {
            currentConfig.columns.splice(idx, 1);
            renderColumns();
        }
    }

    /**
     * Render Parsers Configuration
     */
    function renderParsers() {
        const container = document.getElementById('parsers-config');
        container.innerHTML = '';
        
        if (!currentConfig || !currentConfig.parsers) {
            if (!currentConfig) currentConfig = { columns: [], parsers: [] };
            currentConfig.parsers = [];
        }
        
        currentConfig.parsers.forEach((parser, idx) => {
            const div = document.createElement('div');
            div.className = 'parser-config';
            div.innerHTML = `
                <label>Parser Name:</label>
                <input type="text" value="${parser.name || ''}" onchange="updateParser(${idx}, 'name', this.value)">
                <label>Regex Pattern:</label>
                <input type="text" value="${parser.regex || ''}" placeholder="e.g., ^(\\S+) \\[(.*?)\\]" onchange="updateParser(${idx}, 'regex', this.value)">
                <label>Field Mapping (JSON):</label>
                <input type="text" value="${JSON.stringify(parser.fieldMapping || {})}" placeholder='{"field1": "$1", "field2": "$2"}' onchange="updateParser(${idx}, 'fieldMapping', this.value)">
                <label><input type="checkbox" ${parser.isJson ? 'checked' : ''} onchange="updateParser(${idx}, 'isJson', this.checked)"> JSON Parser</label>
                <button class="btn-remove-column" onclick="removeParser(${idx})" style="margin-top: 10px;">Remove Parser</button>
            `;
            container.appendChild(div);
        });
    }

    /**
     * Add Parser
     */
    function addParser() {
        if (!currentConfig) currentConfig = { columns: [], parsers: [] };
        if (!currentConfig.parsers) currentConfig.parsers = [];
        
        currentConfig.parsers.push({
            name: `Parser ${currentConfig.parsers.length + 1}`,
            regex: '.*',
            fieldMapping: {},
            isJson: false
        });
        renderParsers();
    }

    /**
     * Update Parser
     */
    function updateParser(idx, prop, value) {
        if (currentConfig && currentConfig.parsers && currentConfig.parsers[idx]) {
            if (prop === 'fieldMapping') {
                try {
                    currentConfig.parsers[idx][prop] = JSON.parse(value);
                } catch (e) {
                    // Invalid JSON, keep old value
                }
            } else {
                currentConfig.parsers[idx][prop] = value;
            }
        }
    }

    /**
     * Remove Parser
     */
    function removeParser(idx) {
        if (currentConfig && currentConfig.parsers) {
            currentConfig.parsers.splice(idx, 1);
            renderParsers();
        }
    }

    /**
     * Test Parsing
     */
    function testParsing() {
        const sampleLine = document.getElementById('preview-line').value;
        if (!sampleLine || !currentConfig) return;
        
        const result = parseLine(sampleLine);
        const preview = document.getElementById('preview-result');
        preview.innerHTML = '';
        
        if (result) {
            Object.keys(result).forEach(key => {
                if (key !== 'raw' && key !== 'id') {
                    const div = document.createElement('div');
                    div.className = 'preview-field';
                    div.innerHTML = `<strong>${key}:</strong> ${result[key] || '-'}`;
                    preview.appendChild(div);
                }
            });
        } else {
            preview.innerHTML = '<div style="color: #e74c3c;">No match found. Check your regex pattern.</div>';
        }
    }

    /**
     * Parse a single line using current config
     */
    function parseLine(line) {
        if (!currentConfig || !currentConfig.parsers) return null;
        
        const trimmed = line.trim();
        
        // Try JSON parsers first
        for (let parser of currentConfig.parsers) {
            if (parser.isJson) {
                if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || 
                    (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
                    try {
                        const json = JSON.parse(line);
                        const result = { id: generateId(), raw: line };
                        
                        // Map JSON fields
                        Object.keys(parser.fieldMapping || {}).forEach(field => {
                            const mapping = parser.fieldMapping[field];
                            if (mapping.startsWith('$.')) {
                                // JSON path
                                const path = mapping.substring(2).split(' || ');
                                let value = null;
                                for (let p of path) {
                                    const keys = p.trim().split('.');
                                    value = json;
                                    for (let k of keys) {
                                        if (value && value[k]) {
                                            value = value[k];
                                        } else {
                                            value = null;
                                            break;
                                        }
                                    }
                                    if (value !== null) break;
                                }
                                result[field] = value || '-';
                            } else {
                                result[field] = mapping;
                            }
                        });
                        
                        return result;
                    } catch (e) {
                        // Not valid JSON
                    }
                }
            }
        }
        
        // Try regex parsers
        for (let parser of currentConfig.parsers) {
            if (!parser.isJson && parser.regex) {
                try {
                    const regex = new RegExp(parser.regex);
                    const match = line.match(regex);
                    if (match) {
                        const result = { id: generateId(), raw: line };
                        
                        // Map regex groups
                        Object.keys(parser.fieldMapping || {}).forEach(field => {
                            const mapping = parser.fieldMapping[field];
                            if (mapping.startsWith('$')) {
                                const groupNum = parseInt(mapping.substring(1));
                                result[field] = match[groupNum] || '-';
                            } else {
                                result[field] = mapping || '-';
                            }
                        });
                        
                        return result;
                    }
                } catch (e) {
                    console.error('Invalid regex:', parser.regex, e);
                }
            }
        }
        
        // Fallback: return raw line
        return { id: generateId(), raw: line, message: line };
    }

    /**
     * Generate unique ID
     */
    function generateId() {
        return `log_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    /**
     * Save Configuration
     */
    function saveConfig() {
        if (!currentConfig || !currentConfig.columns || currentConfig.columns.length === 0) {
            showToast('Please define at least one column', 3000);
            return;
        }
        
        if (!currentConfig.parsers || currentConfig.parsers.length === 0) {
            showToast('Please define at least one parser', 3000);
            return;
        }
        
        localStorage.setItem('logAnalyzerConfig', JSON.stringify(currentConfig));
        applyConfig();
        closeConfig();
        showToast('Configuration saved!', 2000);
    }

    /**
     * Apply Configuration
     */
    function applyConfig() {
        if (!currentConfig) return;
        
        // Update table header
        const header = document.getElementById('table-header');
        header.innerHTML = '';
        header.style.display = 'grid';
        
        // Add bookmark column
        const bookmarkHeader = document.createElement('div');
        bookmarkHeader.setAttribute('data-sort', 'bookmark');
        bookmarkHeader.setAttribute('role', 'columnheader');
        bookmarkHeader.setAttribute('aria-sort', 'none');
        header.appendChild(bookmarkHeader);
        
        // Add line number column
        const lineNumberHeader = document.createElement('div');
        lineNumberHeader.setAttribute('data-sort', 'lineNumber');
        lineNumberHeader.setAttribute('role', 'columnheader');
        lineNumberHeader.setAttribute('aria-sort', 'none');
        lineNumberHeader.textContent = 'Line';
        lineNumberHeader.style.cursor = 'pointer';
        header.appendChild(lineNumberHeader);
        
        // Add configured columns
        const visibleColumns = currentConfig.columns.filter(c => c.visible !== false);
        header.style.gridTemplateColumns = `30px 60px ${visibleColumns.map(() => '1fr').join(' ')}`;
        
        visibleColumns.forEach(col => {
            const div = document.createElement('div');
            div.setAttribute('data-sort', col.sortable ? col.key : '');
            div.setAttribute('role', 'columnheader');
            div.setAttribute('aria-sort', 'none');
            div.textContent = col.label;
            if (col.sortable) {
                div.style.cursor = 'pointer';
            }
            header.appendChild(div);
        });
        
        header.style.display = 'grid';
        
        // Initialize column widths
        const visibleCols = currentConfig.columns.filter(c => c.visible !== false);
        const savedWidths = localStorage.getItem('logAnalyzerGenericColumnWidths');
        if (savedWidths) {
            try {
                const parsed = JSON.parse(savedWidths);
                if (Array.isArray(parsed) && parsed.length === visibleCols.length + 1) {
                    columnWidths = parsed; // +1 for bookmark column
                }
            } catch (e) {
                console.warn('Failed to load column widths:', e);
            }
        }
        
        if (!columnWidths || columnWidths.length !== visibleCols.length + 2) {
            columnWidths = [30, 60, ...visibleCols.map(() => 150)]; // Default: 30px for bookmark, 60px for line number, 150px for each column
        }
        
        applyColumnWidths();
        
        // Setup column sorting
        setupColumnSorting();
        
        // Initialize column resizers
        setTimeout(initColumnResizers, 50);
    }

    /**
     * Setup Column Sorting
     */
    function setupColumnSorting() {
        document.querySelectorAll('.table-header > div[data-sort]').forEach(header => {
            header.onclick = () => {
                const col = header.getAttribute('data-sort');
                if (!col) return;
                
                if (sortColumn === col) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = col;
                    sortDirection = 'asc';
                }
                
                sortLogs();
                updateSortIndicators();
            };
        });
    }

    /**
     * Column Resizing
     */
    function initColumnResizers() {
        const header = document.querySelector('.table-header');
        if (!header || !columnWidths) return;
        
        // Remove existing resizers
        header.querySelectorAll('.column-resizer').forEach(r => r.remove());
        
        // Add resizers to each column header (except last)
        const headers = header.querySelectorAll(':scope > div');
        headers.forEach((headerDiv, index) => {
            if (index === headers.length - 1) return; // Skip last column
            
            // Ensure parent has relative positioning
            if (window.getComputedStyle(headerDiv).position === 'static') {
                headerDiv.style.position = 'relative';
            }
            
            const resizer = document.createElement('div');
            resizer.className = 'column-resizer';
            resizer.setAttribute('data-column-index', index);
            resizer.setAttribute('title', 'Drag to resize column');
            headerDiv.appendChild(resizer);
            
            let startX, startWidth, currentIndex;
            
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                isColumnResizing = true;
                currentIndex = index;
                startX = e.clientX;
                
                // Get current width from computed style
                const header = document.querySelector('.table-header');
                const computedStyle = window.getComputedStyle(header);
                const gridTemplateColumns = computedStyle.gridTemplateColumns.split(' ');
                if (gridTemplateColumns[index] && gridTemplateColumns[index] !== '1fr') {
                    startWidth = parseInt(gridTemplateColumns[index]) || columnWidths[index] || 150;
                } else {
                    startWidth = columnWidths[index] || 150;
                }
                
                resizer.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                document.body.style.pointerEvents = 'none';
                resizer.style.pointerEvents = 'auto';
                
                const handleMouseMove = (e) => {
                    if (!isColumnResizing) return;
                    e.preventDefault();
                    const diff = e.clientX - startX;
                    const newWidth = Math.max(50, startWidth + diff); // Min width 50px
                    columnWidths[currentIndex] = newWidth;
                    applyColumnWidths();
                };
                
                const handleMouseUp = (e) => {
                    e.preventDefault();
                    isColumnResizing = false;
                    resizer.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    document.body.style.pointerEvents = '';
                    resizer.style.pointerEvents = '';
                    saveColumnWidths();
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });
        });
    }
    
    function applyColumnWidths() {
        const header = document.querySelector('.table-header');
        const rows = document.querySelectorAll('.row');
        
        if (!header || !columnWidths) return;
        
        const gridTemplate = columnWidths.map((width, index) => {
            if (index === columnWidths.length - 1) return '1fr'; // Last column is flexible
            return `${width}px`;
        }).join(' ');
        
        header.style.gridTemplateColumns = gridTemplate;
        rows.forEach(row => {
            row.style.gridTemplateColumns = gridTemplate;
        });
    }
    
    function saveColumnWidths() {
        localStorage.setItem('logAnalyzerGenericColumnWidths', JSON.stringify(columnWidths));
    }

    /**
     * Update Sort Indicators
     */
    function updateSortIndicators() {
        document.querySelectorAll('.table-header > div[data-sort]').forEach(header => {
            const col = header.getAttribute('data-sort');
            header.setAttribute('aria-sort', 
                sortColumn === col ? (sortDirection === 'asc' ? 'ascending' : 'descending') : 'none'
            );
        });
    }

    /**
     * Sort Logs
     */
    function sortLogs() {
        if (!sortColumn) return;
        
        filteredLogs.sort((a, b) => {
            let aVal, bVal;
            
            if (sortColumn === 'bookmark') {
                const aBookmarked = a.id && bookmarkedLogs.has(a.id);
                const bBookmarked = b.id && bookmarkedLogs.has(b.id);
                if (aBookmarked && !bBookmarked) return sortDirection === 'asc' ? -1 : 1;
                if (!aBookmarked && bBookmarked) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            }
            
            // Special handling for lineNumber column (numeric sort)
            if (sortColumn === 'lineNumber') {
                const aLine = a.lineNumber || 0;
                const bLine = b.lineNumber || 0;
                if (aLine < bLine) return sortDirection === 'asc' ? -1 : 1;
                if (aLine > bLine) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            }
            
            aVal = a[sortColumn];
            bVal = b[sortColumn];
            
            if (aVal == null && bVal == null) return 0;
            if (aVal == null) return sortDirection === 'asc' ? 1 : -1;
            if (bVal == null) return sortDirection === 'asc' ? -1 : 1;
            
            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });
        
        selectedIndex = -1;
        render();
    }

    /**
     * Process File Content
     */
    function processFileContent(lines) {
        if (!currentConfig) {
            showToast('Please configure log format first', 3000);
            return;
        }
        
        selectedIndex = -1;
        statusClassCache.clear();
        const parseErrors = [];
        
        allLogs = lines.map((line, index) => {
            const parsed = parseLine(line);
            let log;
            if (!parsed) {
                parseErrors.push({ line: index + 1, error: 'No parser matched' });
                log = {
                    id: generateId(),
                    raw: line,
                    message: line
                };
            } else {
                log = parsed;
            }
            // Add line number to each log
            log.lineNumber = index + 1;
            return log;
        });
        
        if (parseErrors.length > 0) {
            console.warn(`${parseErrors.length} parsing errors occurred`);
        }
        
        filteredLogs = [...allLogs];
        document.getElementById('search').hidden = false;
        if (btnRefresh) btnRefresh.hidden = false;
        document.getElementById('btn-export').hidden = false;
        if (btnExportBookmarks) btnExportBookmarks.hidden = false;
        document.getElementById('btn-stats').hidden = false;
        if (btnJump) btnJump.hidden = false;
        if (jumpToLineInput) jumpToLineInput.hidden = false;
        if (btnHighlight) btnHighlight.hidden = false;
        
        const statsText = `${allLogs.length} lines loaded`;
        document.getElementById('stats').textContent = statsText;
        
        applyFilters();
        render();
    }

    /**
     * Apply Filters
     */
    function applyFilters() {
        const searchVal = (document.getElementById('search').value || '').toLowerCase();
        
        filteredLogs = allLogs.filter(log => {
            if (!searchVal) return true;
            
            // Search in all fields
            return Object.values(log).some(val => 
                val && String(val).toLowerCase().includes(searchVal)
            );
        });
        
        selectedIndex = -1;
        if (sortColumn) sortLogs();
        else render();
        
        document.getElementById('stats').textContent = 
            `${filteredLogs.length} of ${allLogs.length} entries`;
    }

    /**
     * Render Logs
     */
    function render() {
        if (!currentConfig) return;
        
        const viewport = document.getElementById('viewport');
        const spacer = document.getElementById('spacer');
        const content = document.getElementById('content');
        
        const scrollTop = viewport.scrollTop;
        spacer.style.height = (filteredLogs.length * ROW_HEIGHT) + "px";
        const start = Math.floor(scrollTop / ROW_HEIGHT);
        const end = Math.min(start + VISIBLE_COUNT, filteredLogs.length);
        content.style.transform = `translateY(${start * ROW_HEIGHT}px)`;
        
        const fragment = document.createDocumentFragment();
        const visibleColumns = currentConfig.columns.filter(c => c.visible !== false);
        const searchVal = (document.getElementById('search').value || '').toLowerCase();
        
        filteredLogs.slice(start, end).forEach((log, index) => {
            const realIndex = start + index;
            const isSelected = realIndex === selectedIndex ? 'selected' : '';
            const isBookmarked = log.id && bookmarkedLogs.has(log.id);
            
            const row = document.createElement('div');
            row.className = `row ${isSelected} ${isBookmarked ? 'bookmarked' : ''}`;
            row.setAttribute('role', 'row');
            row.setAttribute('data-index', realIndex);
            row.onclick = () => onRowClick(realIndex);
            
            // Bookmark button
            const bookmarkBtn = document.createElement('button');
            bookmarkBtn.className = 'bookmark-btn';
            bookmarkBtn.textContent = isBookmarked ? '‚≠ê' : '‚òÜ';
            bookmarkBtn.onclick = (e) => {
                e.stopPropagation();
                toggleBookmark(log.id);
            };
            
            const bookmarkCell = document.createElement('div');
            bookmarkCell.style.width = '30px';
            bookmarkCell.style.padding = '0';
            bookmarkCell.appendChild(bookmarkBtn);
            row.appendChild(bookmarkCell);
            
            // Add line number cell
            const lineNumberCell = document.createElement('div');
            lineNumberCell.textContent = log.lineNumber || (realIndex + 1);
            lineNumberCell.style.textAlign = 'right';
            lineNumberCell.style.paddingRight = '10px';
            lineNumberCell.style.color = 'var(--text-main)';
            lineNumberCell.style.opacity = '0.6';
            lineNumberCell.title = `Line ${log.lineNumber || (realIndex + 1)}`;
            row.appendChild(lineNumberCell);
            
            // Add cells for each visible column
            visibleColumns.forEach(col => {
                const div = document.createElement('div');
                let text = log[col.key] || '-';
                
                // Apply custom highlights first
                let highlighted = escapeHtml(String(text));
                const customHighlightRanges = [];
                customHighlights.forEach((color, word) => {
                    if (word && word.trim()) {
                        const regex = new RegExp(escapeRegex(word), 'gi');
                        let match;
                        while ((match = regex.exec(highlighted)) !== null) {
                            customHighlightRanges.push({
                                start: match.index,
                                end: match.index + match[0].length,
                                color: color,
                                word: match[0]
                            });
                        }
                    }
                });
                customHighlightRanges.sort((a, b) => b.start - a.start);
                customHighlightRanges.forEach(range => {
                    const before = highlighted.substring(0, range.start);
                    const match = highlighted.substring(range.start, range.end);
                    const after = highlighted.substring(range.end);
                    highlighted = before + `<span class="custom-highlight" style="background-color: ${range.color};">${match}</span>` + after;
                });
                
                // Then apply search highlights
                if (searchVal && String(text).toLowerCase().includes(searchVal)) {
                    const regex = new RegExp(`(${escapeRegex(searchVal)})`, 'gi');
                    highlighted = highlighted.replace(regex, '<mark>$1</mark>');
                }
                
                div.innerHTML = highlighted;
                
                div.title = String(text);
                row.appendChild(div);
            });
            
            fragment.appendChild(row);
        });
        
        content.innerHTML = '';
        content.appendChild(fragment);
        
        // Apply column widths to newly rendered rows
        applyColumnWidths();
    }

    /**
     * Utility Functions
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function escapeRegex(str) {
        if (!str) return '';
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function showToast(message, duration = 3000) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, duration);
    }

    function toggleBookmark(logId) {
        if (!logId) return;
        if (bookmarkedLogs.has(logId)) {
            bookmarkedLogs.delete(logId);
            showToast('Bookmark removed');
        } else {
            bookmarkedLogs.add(logId);
            showToast('Bookmark added');
        }
        render();
    }

    function onRowClick(index) {
        selectedIndex = index;
        render();
        showDetails(index);
    }

    function showDetails(index) {
        const log = filteredLogs[index];
        if (!log) return;
        
        const rawText = log.raw;
        
        // Clear tabs
        document.getElementById('tab-raw').innerHTML = '';
        document.getElementById('tab-json').innerHTML = '';
        document.getElementById('tab-metadata').innerHTML = '';
        
        // Show search bar and reset search state
        document.getElementById('details-search').style.display = 'block';
        if (detailsSearchInput) detailsSearchInput.value = '';
        if (detailsSearchResults) detailsSearchResults.textContent = '';
        if (btnSearchPrev) {
            btnSearchPrev.disabled = true;
            btnSearchPrev.style.display = 'none';
        }
        if (btnSearchNext) {
            btnSearchNext.disabled = true;
            btnSearchNext.style.display = 'none';
        }
        detailsSearchMatches = [];
        currentSearchMatchIndex = -1;
        
        // RAW tab
        const rawTab = document.getElementById('tab-raw');
        rawTab.textContent = rawText;
        
        // JSON tab
        const jsonTab = document.getElementById('tab-json');
        try {
            const json = JSON.parse(rawText);
            const treeRoot = document.createElement('ul');
            treeRoot.className = 'json-tree';
            treeRoot.style.paddingLeft = '0';
            treeRoot.appendChild(createJsonNode(null, json, false)); // Expanded by default
            jsonTab.appendChild(treeRoot);
        } catch (e) {
            jsonTab.innerHTML = '<div>No JSON data found in this log entry.</div>';
        }
        
        // Metadata tab
        const metadataTab = document.getElementById('tab-metadata');
        let metadataHtml = '<div style="margin-top: 15px;">';
        Object.keys(log).forEach(key => {
            if (key !== 'raw' && key !== 'id') {
                metadataHtml += `<div style="margin: 10px 0;"><strong>${escapeHtml(key)}:</strong> ${escapeHtml(String(log[key] || '-'))}</div>`;
            }
        });
        metadataHtml += '</div>';
        metadataTab.innerHTML = metadataHtml;
        
        // Store original content for each tab (for search restoration)
        document.getElementById('tab-raw').dataset.originalContent = document.getElementById('tab-raw').innerHTML;
        document.getElementById('tab-json').dataset.originalContent = document.getElementById('tab-json').innerHTML;
        document.getElementById('tab-metadata').dataset.originalContent = document.getElementById('tab-metadata').innerHTML;
        
        // Setup search in details
        if (detailsSearchInput) {
            detailsSearchInput.oninput = debounce(() => {
                const searchTerm = detailsSearchInput.value;
                searchInDetails(searchTerm);
            }, 300);
        }
        
        document.getElementById('details-overlay').classList.add('open');
    }

    /**
     * Search in details panel with result count and navigation
     */
    function searchInDetails(searchTerm) {
        detailsSearchMatches = [];
        currentSearchMatchIndex = -1;
        
        if (!searchTerm || !searchTerm.trim()) {
            const activeTab = document.querySelector('.details-tab-content.active');
            if (activeTab && activeTab.dataset.originalContent) {
                activeTab.innerHTML = activeTab.dataset.originalContent;
            }
            if (detailsSearchResults) detailsSearchResults.textContent = '';
            if (btnSearchPrev) {
                btnSearchPrev.disabled = true;
                btnSearchPrev.style.display = 'none';
            }
            if (btnSearchNext) {
                btnSearchNext.disabled = true;
                btnSearchNext.style.display = 'none';
            }
            return;
        }
        
        const activeTab = document.querySelector('.details-tab-content.active');
        if (!activeTab) return;
        
        // Restore original content first
        if (activeTab.dataset.originalContent) {
            activeTab.innerHTML = activeTab.dataset.originalContent;
        }
        
        // Get all text nodes and highlight matches
        const walker = document.createTreeWalker(
            activeTab,
            NodeFilter.SHOW_TEXT,
            {
                acceptNode: function(node) {
                    const parent = node.parentNode;
                    if (!parent || parent.tagName === 'SCRIPT' || parent.tagName === 'STYLE' || parent.tagName === 'MARK') {
                        return NodeFilter.FILTER_REJECT;
                    }
                    return NodeFilter.FILTER_ACCEPT;
                }
            },
            false
        );
        
        const textNodes = [];
        let node;
        while (node = walker.nextNode()) {
            if (node.textContent.trim() && node.parentNode.tagName !== 'MARK') {
                textNodes.push(node);
            }
        }
        
        const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
        let matchCount = 0;
        
        textNodes.forEach(textNode => {
            const text = textNode.textContent;
            if (regex.test(text)) {
                regex.lastIndex = 0;
                const matches = [...text.matchAll(new RegExp(`(${escapeRegex(searchTerm)})`, 'gi'))];
                matches.forEach(() => {
                    detailsSearchMatches.push({
                        element: textNode.parentNode,
                        textNode: textNode
                    });
                    matchCount++;
                });
                
                const highlighted = text.replace(new RegExp(`(${escapeRegex(searchTerm)})`, 'gi'), '<mark>$1</mark>');
                const wrapper = document.createElement('span');
                wrapper.innerHTML = highlighted;
                textNode.parentNode.replaceChild(wrapper, textNode);
            }
        });
        
        // Update result count and navigation buttons
        if (matchCount > 0) {
            if (detailsSearchResults) detailsSearchResults.textContent = `${matchCount} result${matchCount !== 1 ? 's' : ''}`;
            if (btnSearchPrev) {
                btnSearchPrev.disabled = false;
                btnSearchPrev.style.display = 'inline-block';
            }
            if (btnSearchNext) {
                btnSearchNext.disabled = false;
                btnSearchNext.style.display = 'inline-block';
            }
            currentSearchMatchIndex = 0;
            scrollToSearchMatch(0);
        } else {
            if (detailsSearchResults) detailsSearchResults.textContent = 'No results';
            if (btnSearchPrev) {
                btnSearchPrev.disabled = true;
                btnSearchPrev.style.display = 'none';
            }
            if (btnSearchNext) {
                btnSearchNext.disabled = true;
                btnSearchNext.style.display = 'none';
            }
        }
    }

    /**
     * Navigate between search results
     */
    function navigateSearchResults(direction) {
        if (detailsSearchMatches.length === 0) return;
        
        currentSearchMatchIndex += direction;
        if (currentSearchMatchIndex < 0) {
            currentSearchMatchIndex = detailsSearchMatches.length - 1;
        } else if (currentSearchMatchIndex >= detailsSearchMatches.length) {
            currentSearchMatchIndex = 0;
        }
        
        scrollToSearchMatch(currentSearchMatchIndex);
        if (detailsSearchResults) detailsSearchResults.textContent = `${currentSearchMatchIndex + 1} / ${detailsSearchMatches.length}`;
    }

    /**
     * Scroll to a specific search match
     */
    function scrollToSearchMatch(index) {
        if (index < 0 || index >= detailsSearchMatches.length) return;
        
        const activeTab = document.querySelector('.details-tab-content.active');
        if (!activeTab) return;
        
        const marks = activeTab.querySelectorAll('mark');
        if (marks[index]) {
            marks[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            marks.forEach((m, i) => {
                if (i === index) {
                    m.style.backgroundColor = '#ff9800';
                    m.style.outline = '2px solid #ff9800';
                } else {
                    m.style.backgroundColor = '';
                    m.style.outline = '';
                }
            });
        }
    }

    function createJsonNode(key, value, forceCollapse = false) {
        const li = document.createElement('li');
        li.className = 'json-node';
        const container = document.createElement('div');
        
        const isObject = value !== null && typeof value === 'object';
        
        if (isObject) {
            const toggle = document.createElement('span');
            toggle.className = forceCollapse ? 'json-toggle collapsed' : 'json-toggle';
            toggle.textContent = '‚ñº';
            const keySpan = document.createElement('span');
            keySpan.className = 'json-key';
            keySpan.textContent = key ? `${key}: ` : '';
            const typeLabel = Array.isArray(value) ? `Array(${value.length})` : 'Object';
            const infoSpan = document.createElement('span');
            infoSpan.style.color = '#888';
            infoSpan.textContent = `{ ${typeLabel} }`;
            container.appendChild(toggle);
            container.appendChild(keySpan);
            container.appendChild(infoSpan);
            const ul = document.createElement('ul');
            ul.className = forceCollapse ? 'json-tree collapsed-content' : 'json-tree';
            
            for (const k in value) {
                ul.appendChild(createJsonNode(k, value[k], false));
            }
            
            toggle.onclick = (e) => {
                e.stopPropagation();
                const isCollapsed = ul.classList.toggle('collapsed-content');
                toggle.classList.toggle('collapsed', isCollapsed);
            };
            li.appendChild(container);
            li.appendChild(ul);
        } else {
            const keySpan = document.createElement('span');
            keySpan.className = 'json-key';
            keySpan.textContent = key ? `${key}: ` : '';
            const valSpan = document.createElement('span');
            if (typeof value === 'string') {
                valSpan.className = 'json-string';
                valSpan.textContent = `"${value}"`;
            } else if (typeof value === 'number') {
                valSpan.className = 'json-number';
                valSpan.textContent = value;
            } else if (typeof value === 'boolean') {
                valSpan.className = 'json-bool';
                valSpan.textContent = value;
            } else if (value === null) {
                valSpan.className = 'json-null';
                valSpan.textContent = 'null';
            }
            container.style.paddingLeft = '17px';
            container.appendChild(keySpan);
            container.appendChild(valSpan);
            li.appendChild(container);
        }
        return li;
    }

    function switchDetailsTab(tabName) {
        currentDetailsTab = tabName;
        document.querySelectorAll('.details-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.getAttribute('data-tab') === tabName) {
                tab.classList.add('active');
            }
        });
        document.querySelectorAll('.details-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        const activeTabContent = document.getElementById(`tab-${tabName}`);
        activeTabContent.classList.add('active');
        
        // Reset search state when switching tabs
        if (detailsSearchInput) detailsSearchInput.value = '';
        if (detailsSearchResults) detailsSearchResults.textContent = '';
        if (btnSearchPrev) {
            btnSearchPrev.disabled = true;
            btnSearchPrev.style.display = 'none';
        }
        if (btnSearchNext) {
            btnSearchNext.disabled = true;
            btnSearchNext.style.display = 'none';
        }
        detailsSearchMatches = [];
        currentSearchMatchIndex = -1;
        
        // Restore original content for the active tab (remove any search highlights)
        if (activeTabContent && activeTabContent.dataset.originalContent) {
            activeTabContent.innerHTML = activeTabContent.dataset.originalContent;
        }
    }

    function closeDetails() {
        document.getElementById('details-overlay').classList.remove('open');
        // Hide search and reset state
        document.getElementById('details-search').style.display = 'none';
        if (detailsSearchInput) detailsSearchInput.value = '';
        if (detailsSearchResults) detailsSearchResults.textContent = '';
        if (btnSearchPrev) {
            btnSearchPrev.disabled = true;
            btnSearchPrev.style.display = 'none';
        }
        if (btnSearchNext) {
            btnSearchNext.disabled = true;
            btnSearchNext.style.display = 'none';
        }
        detailsSearchMatches = [];
        currentSearchMatchIndex = -1;
    }

    function toggleMaximize() {
        const overlay = document.getElementById('details-overlay');
        if (overlay.style.width === '100vw') {
            overlay.style.width = '600px';
            document.querySelectorAll('.details-actions .btn')[0].textContent = 'Maximize';
        } else {
            overlay.style.width = '100vw';
            document.querySelectorAll('.details-actions .btn')[0].textContent = 'Minimize';
        }
    }

    function copyAll() {
        const activeTab = document.querySelector('.details-tab-content.active');
        if (activeTab) {
            const text = activeTab.textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard');
            });
        }
    }

    function loadFile() {
        if (!currentFile) return;
        if (!currentConfig) {
            showToast('Please configure log format first', 3000);
            return;
        }
        
        const loading = document.getElementById('loading');
        loading.classList.add('active');
        
        const reader = new FileReader();
        const encoding = document.getElementById('encoding-select').value;
        
        reader.onload = (e) => {
            try {
                const rawLines = e.target.result.split('\n').filter(l => l.trim() !== '');
                processFileContent(rawLines);
                
                // Display file path
                const filePathElement = document.getElementById('file-path');
                if (currentFile && filePathElement) {
                    let filePath = '';
                    if (currentFile.fullPath && !currentFile.fullPath.includes('fakepath')) {
                        // Use stored full path from input (only if it's not fakepath)
                        filePath = currentFile.fullPath;
                    } else if (currentFile.path && !currentFile.path.includes('fakepath')) {
                        // Some browsers expose path property (only if it's not fakepath)
                        filePath = currentFile.path;
                    } else if (currentFile.webkitRelativePath) {
                        // For webkit browsers with directory selection
                        filePath = currentFile.webkitRelativePath;
                    } else {
                        const input = document.getElementById('file-input');
                        if (input && input.value) {
                            const inputValue = input.value;
                            // Check if it contains fakepath (browser security restriction)
                            if (inputValue.includes('fakepath')) {
                                // Extract just the filename
                                filePath = inputValue.replace(/^.*[\\\/]/, '');
                            } else {
                                // Use the full path if available
                                filePath = inputValue;
                            }
                        }
                        // Fallback to filename if no path found
                        if (!filePath && currentFile.name) {
                            filePath = currentFile.name;
                        }
                    }
                    if (filePath) {
                        filePathElement.textContent = `File: ${filePath}`;
                        filePathElement.classList.add('active');
                    }
                }
                
                showToast(`Loaded ${rawLines.length} log entries`);
            } catch (error) {
                showToast(`Error loading file: ${error.message}`, 5000);
            } finally {
                loading.classList.remove('active');
            }
        };
        
        reader.onerror = () => {
            loading.classList.remove('active');
            showToast('Error reading file', 5000);
        };
        
        reader.readAsText(currentFile, encoding);
    }

    /**
     * Event Listeners
     */
    const viewport = document.getElementById('viewport');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const searchInput = document.getElementById('search');
    const btnConfig = document.getElementById('btn-config');
    const btnRefresh = document.getElementById('btn-refresh');
    const btnExport = document.getElementById('btn-export');
    const btnExportBookmarks = document.getElementById('btn-export-bookmarks');
    const btnStats = document.getElementById('btn-stats');
    const btnJump = document.getElementById('btn-jump');
    const jumpToLineInput = document.getElementById('jump-to-line');
    const btnHighlight = document.getElementById('btn-highlight');
    const btnTheme = document.getElementById('btn-theme');
    const detailsSearchInput = document.getElementById('details-search-input');
    const detailsSearchResults = document.getElementById('details-search-results');
    const btnSearchPrev = document.getElementById('btn-search-prev');
    const btnSearchNext = document.getElementById('btn-search-next');
    
    // Custom word highlighting state
    let customHighlights = new Map(); // word -> color
    let detailsSearchMatches = [];
    let currentSearchMatchIndex = -1;

    // Details search navigation
    if (btnSearchPrev) btnSearchPrev.onclick = () => navigateSearchResults(-1);
    if (btnSearchNext) btnSearchNext.onclick = () => navigateSearchResults(1);

    // Initialize
    initConfig();

    // Event listeners
    btnConfig.onclick = showConfigModal;
    dropZone.onclick = () => fileInput.click();
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            currentFile = e.dataTransfer.files[0];
            if (e.dataTransfer.items && e.dataTransfer.items[0]) {
                const entry = e.dataTransfer.items[0].webkitGetAsEntry();
                if (entry && entry.fullPath) {
                    currentFile.fullPath = entry.fullPath;
                }
            }
            loadFile();
        }
    });

    fileInput.onchange = (e) => {
        currentFile = e.target.files[0];
        if (currentFile) {
            // Store the path from input value if available (but browsers may mask it with fakepath)
            if (e.target.value) {
                const inputValue = e.target.value;
                // Only store if it's not fakepath (browser security restriction)
                if (!inputValue.includes('fakepath')) {
                    currentFile.fullPath = inputValue;
                } else {
                    // Store just the filename
                    currentFile.fullPath = inputValue.replace(/^.*[\\\/]/, '');
                }
            }
            loadFile();
        }
    };

    searchInput.oninput = debounce(() => {
        applyFilters();
    }, 300);

    viewport.addEventListener('scroll', debounce(() => {
        render();
    }, 10));

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (filteredLogs.length === 0) return;
        if (document.activeElement === searchInput) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, filteredLogs.length - 1);
            render();
            showDetails(selectedIndex);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            render();
            showDetails(selectedIndex);
        } else if (e.key === 'Escape') {
            closeDetails();
        } else if (e.key === 'f' && e.ctrlKey) {
            e.preventDefault();
            searchInput.focus();
        }
    });

    // Theme toggle
    btnTheme.onclick = () => {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        btnTheme.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    };

    // Load theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        btnTheme.textContent = '‚òÄÔ∏è';
    }

    // Export (simplified)
    btnRefresh.onclick = () => {
        if (currentFile) {
            loadFile();
            showToast('Refreshing file...');
        } else {
            showToast('No file loaded');
        }
    };
    btnExport.onclick = () => {
        if (filteredLogs.length === 0) return;
        const csv = generateCSV();
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `logs_${Date.now()}.csv`;
        link.click();
        showToast('Exported to CSV');
    };

    // Export bookmarks
    if (btnExportBookmarks) {
        btnExportBookmarks.onclick = () => {
            if (bookmarkedLogs.size === 0) {
                showToast('No bookmarks to export');
                return;
            }
            const bookmarkedLogsArray = filteredLogs.filter(log => log.id && bookmarkedLogs.has(log.id));
            if (bookmarkedLogsArray.length === 0) {
                showToast('No bookmarked logs in current filter');
                return;
            }
            const csv = generateCSVForLogs(bookmarkedLogsArray);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `bookmarks_${Date.now()}.csv`;
            link.click();
            showToast(`Exported ${bookmarkedLogsArray.length} bookmarked entries`);
        };
    }

    function generateCSVForLogs(logs) {
        if (!currentConfig) return '';
        const visibleColumns = currentConfig.columns.filter(c => c.visible !== false);
        const headers = visibleColumns.map(c => c.label).join(',');
        const rows = logs.map(log => {
            return visibleColumns.map(col => {
                const val = log[col.key] || '-';
                return `"${String(val).replace(/"/g, '""')}"`;
            }).join(',');
        });
        return headers + '\n' + rows.join('\n');
    }

    // Jump to line
    if (btnJump && jumpToLineInput) {
        btnJump.onclick = jumpToLine;
        jumpToLineInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                jumpToLine();
            }
        });
    }

    function jumpToLine() {
        const lineNumber = parseInt(jumpToLineInput.value);
        if (!lineNumber || lineNumber < 1) {
            showToast('Please enter a valid line number');
            return;
        }
        const targetIndex = lineNumber - 1;
        if (targetIndex >= filteredLogs.length) {
            showToast(`Line ${lineNumber} is out of range. Total lines: ${filteredLogs.length}`);
            return;
        }
        selectedIndex = targetIndex;
        handleSelectionChange();
        const rowHeight = ROW_HEIGHT;
        const targetScroll = selectedIndex * rowHeight;
        viewport.scrollTop = Math.max(0, targetScroll - viewport.clientHeight / 2);
        render();
        showToast(`Jumped to line ${lineNumber}`);
    }

    // Highlight picker
    if (btnHighlight) {
        btnHighlight.onclick = showHighlightPicker;
    }

    function showHighlightPicker() {
        const picker = document.getElementById('highlight-picker');
        if (picker) {
            picker.classList.add('active');
            const wordInput = document.getElementById('highlight-word');
            if (wordInput) wordInput.focus();
        }
    }

    function applyHighlight() {
        const wordInput = document.getElementById('highlight-word');
        const colorInput = document.getElementById('highlight-color');
        const word = wordInput.value.trim();
        const color = colorInput.value;
        if (!word) {
            showToast('Please enter a word to highlight');
            return;
        }
        customHighlights.set(word.toLowerCase(), color);
        closeHighlightPicker();
        render();
        showToast(`Highlighting "${word}" in ${color}`);
    }

    function clearAllHighlights() {
        customHighlights.clear();
        closeHighlightPicker();
        render();
        showToast('All highlights cleared');
    }

    function closeHighlightPicker() {
        const picker = document.getElementById('highlight-picker');
        if (picker) {
            picker.classList.remove('active');
        }
    }

    function generateCSV() {
        if (!currentConfig) return '';
        const visibleColumns = currentConfig.columns.filter(c => c.visible !== false);
        const headers = visibleColumns.map(c => c.label).join(',');
        const rows = filteredLogs.map(log => {
            return visibleColumns.map(col => {
                const val = log[col.key] || '-';
                return `"${String(val).replace(/"/g, '""')}"`;
            }).join(',');
        });
        return headers + '\n' + rows.join('\n');
    }

    // Stats (simplified)
    btnStats.onclick = () => {
        const panel = document.getElementById('stats-panel');
        panel.classList.toggle('active');
        if (panel.classList.contains('active')) {
            const content = document.getElementById('stats-content');
            content.innerHTML = `
                <div><strong>Total:</strong> ${allLogs.length}</div>
                <div><strong>Filtered:</strong> ${filteredLogs.length}</div>
            `;
        }
    };
</script>
</body>
</html>

